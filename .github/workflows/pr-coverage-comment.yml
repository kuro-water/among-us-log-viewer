name: PR Coverage Comment
on:
  pull_request:
    types: [opened, synchronize, reopened]
    # Only run coverage comment when changes touch code areas
    paths:
      - "lib/**"
      - "components/**"
      - "hooks/**"
      - "app/**"
      - "types/**"
      - "config/**"
      - "package.json"
      - "package-lock.json"
      - "jest.config.ts"
      - "tsconfig.json"

jobs:
  comment-coverage:
    runs-on: ubuntu-latest
    concurrency:
      group: coverage-comment-pr-${{ github.event.pull_request.number }}
      cancel-in-progress: true

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"
      - name: Install dependencies
        run: npm ci
      - run: npm run test:coverage
      - name: Upload HTML coverage report as artifact (head)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/lcov-report

      - name: Checkout base commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          path: base
          fetch-depth: 0

      - name: Run coverage on base commit
        run: |
          npm ci
          npm run test:coverage
        working-directory: base

      - name: Upload HTML coverage report as artifact (base)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-base
          path: base/coverage/lcov-report

      - name: Create/update PR coverage comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'coverage/coverage-summary.json';
            const issue_number = context.issue.number;

            if (!fs.existsSync(path)) {
              // Post a comment instead of failing the job for better UX
              await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number, body: '**Coverage:** summary not found (jest may have failed). Check workflow logs.' });
              return;
            }

            const report = JSON.parse(fs.readFileSync(path, 'utf8'));
            let baseReport = null;
            const basePath = 'base/coverage/coverage-summary.json';
            if (fs.existsSync(basePath)) {
              baseReport = JSON.parse(fs.readFileSync(basePath, 'utf8'));
            }
            const total = report.total || {};

            function pct(obj) {
              return (obj && obj.pct != null) ? obj.pct.toFixed(2) + '%' : 'N/A';
            }

            let diffTable = '';
            if (baseReport && baseReport.total) {
              const b = baseReport.total;
              diffTable = `| Metric | PR / Base | Delta |\n|---|---:|---:|\n` +
                `| Lines | ${pct(total.lines)} / ${pct(b.lines)} | ${deltaPct(total.lines, b.lines)} |\n` +
                `| Statements | ${pct(total.statements)} / ${pct(b.statements)} | ${deltaPct(total.statements, b.statements)} |\n` +
                `| Branches | ${pct(total.branches)} / ${pct(b.branches)} | ${deltaPct(total.branches, b.branches)} |\n` +
                `| Functions | ${pct(total.functions)} / ${pct(b.functions)} | ${deltaPct(total.functions, b.functions)} |\n\n`;
            }

            function deltaPct(a, b) {
              if (!a || !b || a.pct == null || b.pct == null) return 'N/A';
              const d = (a.pct - b.pct).toFixed(2);
              return (d > 0 ? '+' + d : d) + '%';
            }

            const summaryDelta = (baseReport && baseReport.total) ? deltaPct(total.lines, baseReport.total.lines) : 'N/A';

            const body = `<!-- coverage-comment -->\n### Coverage Report\n\n| Metric | % |\n|---|---:|\n| Lines | ${pct(total.lines)} |\n| Statements | ${pct(total.statements)} |\n| Branches | ${pct(total.branches)} |\n| Functions | ${pct(total.functions)} |\n\n${diffTable}**Summary (Lines delta):** ${summaryDelta}\n\n> Generated by Jest coverage in CI`;

            // Find existing bot comment and update, otherwise create
            const comments = await github.rest.issues.listComments({ owner: context.repo.owner, repo: context.repo.repo, issue_number });
            const existing = comments.data.find(c => c.body && c.body.includes('<!-- coverage-comment -->'));

            if (existing) {
              await github.rest.issues.updateComment({ owner: context.repo.owner, repo: context.repo.repo, comment_id: existing.id, body });
            } else {
              await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number, body });
            }
